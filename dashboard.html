{% extends "layout.html" %}
{% set title="Reports Dashboard" %}
{% set active="dashboard" %}
{% block content %}

<div class="row" style="align-items:center;justify-content:space-between;margin-bottom:12px;">
  <div>
    <h3>Reports Dashboard</h3>
    <div class="muted">Consolidated reporting library + KPI snapshots (demo with mock data)</div>
  </div>
  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <a class="btn outline" href="{{ url_for('export_kpis_csv') }}">Export KPI CSV</a>
    <a class="btn primary" href="{{ url_for('create') }}">+ Create Report</a>
  </div>
</div>

<div class="row">
  <div class="col"><div class="card"><div class="p">
    <div class="muted">Avg SLA</div><div style="font-size:26px;font-weight:700;">{{ '%.2f' % (cards.avg_sla or 0) }}%</div>
  </div></div></div>
  <div class="col"><div class="card"><div class="p">
    <div class="muted">Total P1</div><div style="font-size:26px;font-weight:700;">{{ cards.total_p1 or 0 }}</div>
  </div></div></div>
  <div class="col"><div class="card"><div class="p">
    <div class="muted">Avg MTTR</div><div style="font-size:26px;font-weight:700;">{{ '%.0f' % (cards.avg_mttr or 0) }} min</div>
  </div></div></div>
  <div class="col"><div class="card"><div class="p">
    <div class="muted">Total Risks</div><div style="font-size:26px;font-weight:700;">{{ cards.total_risks or 0 }}</div>
  </div></div></div>
</div>

<div class="card" style="margin-top:12px;">
  <div class="p">
    <form method="get" action="{{ url_for('dashboard') }}">
      <div class="grid-2">
        <div>
          <label class="muted">Search</label>
          <input name="q" value="{{ request.args.get('q','') }}" placeholder="Type: project / owner / report id / type">
        </div>
        <div class="grid-2">
          <div>
            <label class="muted">Project</label>
            <select name="project">
              <option value="">All</option>
              {% for p in projects %}
                <option value="{{p}}" {% if request.args.get('project','')==p %}selected{% endif %}>{{p}}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="muted">Week</label>
            <select name="week">
              <option value="">All</option>
              {% for w in weeks %}
                <option value="{{w}}" {% if request.args.get('week','')==w %}selected{% endif %}>{{w}}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="muted">Owner</label>
            <select name="owner">
              <option value="">All</option>
              {% for o in owners %}
                <option value="{{o}}" {% if request.args.get('owner','')==o %}selected{% endif %}>{{o}}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="muted">Type</label>
            <select name="report_type">
              <option value="">All</option>
              {% for t in types %}
                <option value="{{t}}" {% if request.args.get('report_type','')==t %}selected{% endif %}>{{t}}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn dark" type="submit">Apply</button>
        <a class="btn outline" href="{{ url_for('dashboard') }}">Reset</a>
        <a class="btn outline" href="{{ url_for('api_kpis') }}" target="_blank">Power BI API (kpis)</a>
        <a class="btn outline" href="{{ url_for('api_reports') }}" target="_blank">Power BI API (reports)</a>
      </div>
    </form>
  </div>
</div>

<div class="card" style="margin-top:12px;">
  <div class="p">
    <table>
      <thead>
        <tr>
          <th>Report ID</th><th>Project</th><th>Week</th><th>Owner</th><th>Type</th><th>Status</th><th>Updated</th><th></th>
        </tr>
      </thead>
      <tbody>
        {% for r in reports %}
          <tr>
            <td><b>{{ r.report_id }}</b></td>
            <td>{{ r.project }}</td>
            <td>{{ r.week }}</td>
            <td>{{ r.owner }}</td>
            <td>{{ r.report_type }}</td>
            <td>
              {% if r.status == 'Final' %}
                <span class="badge green">Final</span>
              {% else %}
                <span class="badge amber">Draft</span>
              {% endif %}
            </td>
            <td class="muted">{{ r.updated_at }}</td>
            <td><a class="btn outline" href="{{ url_for('report_detail', report_id=r.report_id) }}">View</a></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if not reports %}
      <div class="muted">No reports found.</div>
    {% endif %}
  </div>
</div>

{% endblock %}
