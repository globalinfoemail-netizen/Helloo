{% extends "layout.html" %}
{% set title=report.report_id ~ " — Report" %}
{% set active="dashboard" %}
{% block content %}
<a href="{{ url_for('dashboard') }}">← Back</a>

<div class="row" style="align-items:center;justify-content:space-between;margin-top:10px;">
  <div>
    <h3>{{ report.report_id }} — {{ report.project }} ({{ report.week }})</h3>
    <div class="muted">Owner: {{ report.owner }} | Type: {{ report.report_type }} | Status: {{ report.status }}</div>
  </div>
  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    {% if report.storage_url %}
      <a class="btn outline" href="{{ report.storage_url }}" target="_blank">Open Storage Link</a>
    {% endif %}
    <form method="post" action="{{ url_for('generate_ppt', report_id=report.report_id) }}">
      <button class="btn primary" type="submit">Generate PPT</button>
    </form>
  </div>
</div>

<div class="grid-2" style="margin-top:12px;">
  <div>
    <div class="card">
      <div class="p">
        <h4>Latest KPI Snapshot</h4>
        {% if kpi %}
          <div class="row" style="margin-top:8px;">
            <div class="col"><b>SLA:</b> {{ kpi.sla }}%</div>
            <div class="col"><b>P1:</b> {{ kpi.p1_incidents }}</div>
            <div class="col"><b>MTTR:</b> {{ kpi.mttr_minutes }} min</div>
            <div class="col"><b>Risks:</b> {{ kpi.risk_count }}</div>
          </div>
          <div style="margin-top:10px;">
            <b>RAG:</b>
            {% if kpi.rag == 'Green' %}<span class="badge green">Green</span>
            {% elif kpi.rag == 'Amber' %}<span class="badge amber">Amber</span>
            {% else %}<span class="badge red">Red</span>{% endif %}
          </div>
          <div class="muted" style="margin-top:8px;">Updated: {{ kpi.created_at }}</div>
        {% else %}
          <div class="muted">No KPI snapshots yet.</div>
        {% endif %}
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="p">
        <h4>Add KPI Snapshot</h4>
        <form method="post" action="{{ url_for('add_kpi', report_id=report.report_id) }}">
          <div class="grid-2">
            <input name="sla" placeholder="SLA %" required>
            <input name="p1_incidents" placeholder="P1" required>
            <input name="mttr_minutes" placeholder="MTTR min" required>
            <input name="risk_count" placeholder="Risks" required>
            <select name="rag">
              <option>Green</option>
              <option>Amber</option>
              <option>Red</option>
            </select>
          </div>
          <div style="margin-top:10px;">
            <button class="btn dark" type="submit">Save KPIs</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="p">
        <h4>Power BI endpoints</h4>
        <div class="muted">Use Power BI → Get Data → Web:</div>
        <div><code>http://127.0.0.1:5000/api/kpis</code></div>
        <div><code>http://127.0.0.1:5000/api/reports</code></div>
        <div style="margin-top:8px;"><a href="{{ url_for('export_kpis_csv') }}">Download KPI CSV</a></div>
      </div>
    </div>
  </div>

  <div>
    <div class="card">
      <div class="p">
        <h4>Version History</h4>
        {% if versions %}
          {% for v in versions %}
            <div style="margin-bottom:10px;">
              <span class="badge grey">v{{ v.version_no }}</span>
              <span class="muted">{{ v.created_at }}</span>
              <div>{{ v.notes }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="muted">No versions yet.</div>
        {% endif %}
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="p">
        <h4>Add Version</h4>
        <form method="post" action="{{ url_for('add_version', report_id=report.report_id) }}">
          <textarea name="notes" rows="4" placeholder="What changed in this version?" required></textarea>
          <div style="margin-top:10px;">
            <button class="btn dark" type="submit">Save Version</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div class="p">
        <h4>Generated PPTs</h4>
        <div class="muted">Demo decks are saved locally under <code>output_ppt/</code>.</div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
