import sqlite3
from flask import Flask, render_template_string, jsonify

app = Flask(__name__)
DB = "gpse.db"

DASHBOARD_HTML = """
<!doctype html>
<html>
<head>
<title>GPSE KPI Hub</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container mt-4">
<h3>GPSE KPI Catalogue</h3>
<table class="table table-bordered">
<tr><th>Section</th><th>KPI Code</th><th>Name</th><th></th></tr>
{% for k in kpis %}
<tr>
<td>{{k.section}}</td>
<td>{{k.code}}</td>
<td>{{k.name}}</td>
<td><a class="btn btn-sm btn-primary" href="/kpi/{{k.code}}">View Formula</a></td>
</tr>
{% endfor %}
</table>
</div>
</body>
</html>
"""

KPI_HTML = """
<!doctype html>
<html>
<head>
<title>{{kpi.code}}</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container mt-4">
<a href="/" class="btn btn-secondary btn-sm">Back</a>
<h3>{{kpi.code}} â€“ {{kpi.name}}</h3>
<p><b>Formula:</b> {{kpi.formula}}</p>
<h5>Values</h5>
<ul>
{% for v in values %}
<li>{{v.period}} : {{v.value}}</li>
{% endfor %}
</ul>
</div>
</body>
</html>
"""

def db():
    c = sqlite3.connect(DB)
    c.row_factory = sqlite3.Row
    return c

def init():
    with db() as c:
        c.execute("CREATE TABLE IF NOT EXISTS kpi_master (section TEXT, code TEXT, name TEXT, formula TEXT)")
        c.execute("CREATE TABLE IF NOT EXISTS kpi_values (code TEXT, period TEXT, value TEXT)")
        if c.execute("SELECT COUNT(*) FROM kpi_master").fetchone()[0] == 0:
            c.execute("INSERT INTO kpi_master VALUES ('NPFS','CRI','Change Risk Index','High Risk / Total * 100')")
            c.execute("INSERT INTO kpi_master VALUES ('NPFS','SEV2','Severity 2 Incidents','Count of Sev2 incidents')")
            c.execute("INSERT INTO kpi_values VALUES ('CRI','W35','4.8')")
            c.execute("INSERT INTO kpi_values VALUES ('SEV2','W35','2')")

@app.route("/")
def home():
    with db() as c:
        kpis = c.execute("SELECT * FROM kpi_master").fetchall()
    return render_template_string(DASHBOARD_HTML, kpis=kpis)

@app.route("/kpi/<code>")
def kpi(code):
    with db() as c:
        kpi = c.execute("SELECT * FROM kpi_master WHERE code=?", (code,)).fetchone()
        values = c.execute("SELECT * FROM kpi_values WHERE code=?", (code,)).fetchall()
    return render_template_string(KPI_HTML, kpi=kpi, values=values)

@app.route("/api/kpis")
def api_kpis():
    with db() as c:
        return jsonify([dict(r) for r in c.execute("SELECT * FROM kpi_master")])

@app.route("/api/kpi_values")
def api_kpi_values():
    with db() as c:
        return jsonify([dict(r) for r in c.execute("SELECT * FROM kpi_values")])

if __name__ == "__main__":
    init()
    app.run(debug=True)
